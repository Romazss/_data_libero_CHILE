# Makefile para Biblioteca de Datos Abiertos de Chile
# Facilita las tareas comunes de desarrollo y mantenimiento

.PHONY: help install check-python check-r run-backend test-api clean docs

# ConfiguraciÃ³n
PYTHON = python3
BACKEND_DIR = web_app/backend
FRONTEND_DIR = web_app/frontend
SCRIPTS_DIR = data_sources/scripts

# Ayuda por defecto
help:
	@echo "ğŸ“š Biblioteca de Datos Abiertos de Chile - Comandos Disponibles"
	@echo ""
	@echo "ğŸ”§ ConfiguraciÃ³n:"
	@echo "  install        Instalar dependencias Python"
	@echo "  setup-env      Configurar entorno virtual"
	@echo ""
	@echo "ğŸƒ EjecuciÃ³n:"
	@echo "  run-backend    Ejecutar servidor Flask"
	@echo "  open-frontend  Abrir frontend en navegador"
	@echo ""
	@echo "âœ… VerificaciÃ³n:"
	@echo "  check-python   Verificar datasets con script Python"
	@echo "  check-r        Verificar datasets con script R (requiere R)"
	@echo "  test-api       Probar endpoints del backend"
	@echo ""
	@echo "ğŸ“Š Utilidades:"
	@echo "  status         Estado actual de todos los datasets"
	@echo "  clean          Limpiar archivos temporales"
	@echo "  docs           Generar/actualizar documentaciÃ³n"

# InstalaciÃ³n de dependencias
install:
	@echo "ğŸ“¦ Instalando dependencias Python..."
	pip install -r $(BACKEND_DIR)/requirements.txt

setup-env:
	@echo "ğŸ”§ Configurando entorno virtual..."
	python3 -m venv .venv
	@echo "âœ… Entorno creado. Activa con: source .venv/bin/activate"

# EjecuciÃ³n del backend
run-backend:
	@echo "ğŸš€ Iniciando servidor Flask..."
	cd $(BACKEND_DIR) && $(PYTHON) app.py

# Abrir frontend
open-frontend:
	@echo "ğŸŒ Abriendo frontend en navegador..."
	@if command -v open >/dev/null 2>&1; then \
		open file://$(PWD)/$(FRONTEND_DIR)/index.html; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open file://$(PWD)/$(FRONTEND_DIR)/index.html; \
	else \
		echo "âŒ No se pudo abrir automÃ¡ticamente. Abre manualmente:"; \
		echo "   file://$(PWD)/$(FRONTEND_DIR)/index.html"; \
	fi

# VerificaciÃ³n con Python
check-python:
	@echo "ğŸ” Verificando datasets con Python..."
	$(PYTHON) $(SCRIPTS_DIR)/download_example.py --check-only

# VerificaciÃ³n con R (si estÃ¡ disponible)
check-r:
	@echo "ğŸ” Verificando datasets con R..."
	@if command -v Rscript >/dev/null 2>&1; then \
		Rscript -e "source('$(SCRIPTS_DIR)/download_example.R'); download_chile_data(check_only = TRUE)"; \
	else \
		echo "âŒ R no estÃ¡ instalado. Instala R para usar esta funciÃ³n."; \
	fi

# Probar API del backend
test-api:
	@echo "ğŸ§ª Probando endpoints del backend..."
	@echo "Endpoint /health:"
	@curl -s http://localhost:5001/health || echo "âŒ Backend no estÃ¡ ejecutÃ¡ndose"
	@echo ""
	@echo "Endpoint /status:"
	@curl -s http://localhost:5001/status | head -c 200 || echo "âŒ Backend no estÃ¡ ejecutÃ¡ndose"
	@echo "..."

# Estado de datasets
status:
	@echo "ğŸ“Š Estado actual de datasets:"
	@$(PYTHON) $(SCRIPTS_DIR)/download_example.py --check-only

# Limpiar archivos temporales
clean:
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	find . -name "*.pyo" -delete 2>/dev/null || true
	find . -name ".DS_Store" -delete 2>/dev/null || true
	rm -rf downloads/ tmp/ logs/ 2>/dev/null || true
	@echo "âœ… Limpieza completada"

# Generar documentaciÃ³n (placeholder para futuras expansiones)
docs:
	@echo "ğŸ“– Generando documentaciÃ³n..."
	@echo "âœ… DocumentaciÃ³n disponible en docs/"
	@echo "   â€¢ docs/intro.md - IntroducciÃ³n general"
	@echo "   â€¢ docs/Fase1.md - DocumentaciÃ³n de Fase 1"
	@echo "   â€¢ README.md - GuÃ­a principal"

# Comandos para desarrollo
dev-install: setup-env install
	@echo "ğŸ”§ Entorno de desarrollo configurado"

dev-start: run-backend
	@echo "ğŸš€ Entorno de desarrollo iniciado"

# Comando compuesto: verificar todo
check-all: check-python
	@echo ""
	@echo "âœ… VerificaciÃ³n completa terminada"

# Comando compuesto: inicio completo
start: run-backend open-frontend
	@echo "ğŸ‰ AplicaciÃ³n iniciada completamente"
